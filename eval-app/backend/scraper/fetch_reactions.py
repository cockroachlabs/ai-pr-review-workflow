from __future__ import annotations
from typing import Dict, List, Tuple
import os, sys
from datetime import datetime, timedelta, timezone
from dotenv import load_dotenv
from github import Github, Auth
from logger import logger
from tabulate import tabulate

load_dotenv()

PR_REVIEW_LABEL = "ai-pr-reviewer"
REVIEW_COMMENT_TAG = "Comment generated by ai-pr-review-workflow" # this tag marks review comments added by the AI PR review workflow

def _process_comment(repo, pr, comment) -> Dict | None:
    """Return a row dict if the body has our tag; else None."""
    body = getattr(comment, "body", "") or ""
    if REVIEW_COMMENT_TAG not in body:
        return None

    try:
        reactions = comment.get_reactions()
    except Exception:
        reactions = []

    positive = sum(1 for r in reactions if getattr(r, "content", None) == "+1")
    negative = sum(1 for r in reactions if getattr(r, "content", None) == "-1")
    sentiment = "positive" if positive > negative else "negative" if negative > positive else "neutral"

    return {
        "ai_review_id": f"{repo.full_name}-{comment.id}",
        "repo_name": repo.full_name,
        "pr_number": pr.number,
        "pr_url": pr.url,
        "pr_title": pr.title,
        "pr_review_id": comment.pull_request_review_id,
        "review_comment_id": comment.id,
        "review_comment_url": comment.url,
        "original_commit_sha": getattr(comment, "original_commit_id", None),
        "workflow_version": "unknown",
        "created_at": getattr(comment, "created_at", None),
        "sentiment": sentiment,
        "positive_reactions": positive,
        "negative_reactions": negative,
    }

def fetch_from_github(enabled_repos: List[str], days: int = 7) -> Tuple[List[Dict], int, int]:
    """Pure fetch: no DB calls; just return rows, processed_count, error_count."""
    token = os.getenv("GITHUB_TOKEN")
    if not token:
        sys.exit("❌ ERROR: GITHUB_TOKEN is not set")

    gh = Github(auth=Auth.Token(token))  # modern PyGithub auth
    since_dt = datetime.now(timezone.utc) - timedelta(days=days)

    rows: List[Dict] = []
    processed = 0
    errors = 0

    for repo_name in enabled_repos:
        try:
            repo = gh.get_repo(repo_name)
            issues = repo.get_issues(state="all", labels=[PR_REVIEW_LABEL], since=since_dt)

            for issue in issues:
                if not getattr(issue, "pull_request", None):
                    continue
                pr = repo.get_pull(issue.number)

                # You can also add: pr.get_issue_comments() and pr.get_reviews() if needed
                for comment in pr.get_review_comments():
                    row = _process_comment(repo, pr, comment)
                    if row:
                        rows.append(row)
                        processed += 1

        except Exception as e:
            logger.error(f"⚠️  Error processing {repo_name}: {e}")
            errors += 1

    return rows, processed, errors

def print_table(reviews: List[Dict]) -> None:
    if not reviews:
        logger.info("\nNo reviews found.")
        return

    headers = ["AI Review ID", "Repo", "PR #", "Sentiment", "+1", "-1", "Version", "Comment URL"]
    table = [
        (
            r["ai_review_id"],
            r["repo_name"],
            r["pr_number"],
            r["sentiment"],
            r["positive_reactions"],
            r["negative_reactions"],
            r["workflow_version"],
            r["review_comment_url"],
        )
        for r in reviews
    ]
    logger.info("\n=== Review Summary ===")
    logger.info(tabulate(table, headers=headers, tablefmt="github"))
