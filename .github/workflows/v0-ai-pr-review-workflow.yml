name: AI PR Reviewer

on:
  workflow_call:
    inputs:
      label:
        type: string
        required: false
        default: test-ai-pr-reviewer
      model:
        type: string
        required: false
        default: claude-sonnet-4-5@20250929
      claude_allowed_tools:
        type: string
        required: false
        default: "Read,Grep,Glob,Bash(gh pr diff:*),Bash(gh pr view:*)"
      timeout:
        type: number
        required: false
        default: 60
      stages_json:
        type: string
        required: true
        description: "JSON array defining review stages. Each stage has: name (required), path (required), repo (optional, defaults to caller repo), ref (optional, defaults to PR head/current ref)"
    secrets:
      token:
        required: true

# Constants for Vertex/GCP
env:
  GCP_VERTEX_PROJECT_ID: vertex-model-runners
  CLOUD_ML_REGION: global
  GCP_SERVICE_ACCOUNT: ai-review@dev-inf-prod.iam.gserviceaccount.com
  GCP_WIF_PROVIDER: projects/72497726731/locations/global/workloadIdentityPools/ai-review/providers/ai-review

permissions:
  contents: read
  pull-requests: write

jobs:
  claude-code-pr-review:
    runs-on: ubuntu-latest
    timeout-minutes: ${{ inputs.timeout }}
    if: "!startsWith(github.base_ref, 'release-') && !contains(github.event.pull_request.labels.*.name, 'O-No-AI-Review') && github.event.pull_request.merged == false"
    strategy:
      fail-fast: false
      matrix:
        stage: ${{ fromJSON(inputs.stages_json) }}
    
    permissions:
      contents: read
      pull-requests: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          ref: ${{ github.event.pull_request.head.sha || github.ref }}
          fetch-depth: 1

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v3
        with:
          project_id: ${{ env.GCP_VERTEX_PROJECT_ID }}
          service_account: ${{ env.GCP_SERVICE_ACCOUNT }}
          workload_identity_provider: ${{ env.GCP_WIF_PROVIDER }}

      - name: Get prompt from file
        id: get_prompt
        run: |
          # Default to caller repo if not specified
          REPO="${{ matrix.stage.repo }}"
          if [ -z "$REPO" ]; then
            REPO="${{ github.repository }}"
            echo "No repo specified, using caller repo: $REPO"
          fi

          # Default to PR head sha or current ref if not specified
          REF="${{ matrix.stage.ref }}"
          if [ -z "$REF" ]; then
            REF="${{ github.event.pull_request.head.sha || github.ref }}"
            echo "No ref specified, using: $REF"
          fi

          # Construct the raw.githubusercontent.com URL
          PROMPT_URL="https://raw.githubusercontent.com/$REPO/$REF/${{ matrix.stage.path }}"
          echo "Fetching prompt from: $PROMPT_URL"

          # Download the prompt file (with auth for private repos)
          PROMPT_CONTENT=$(curl -fsSL -H "Authorization: token ${{ secrets.token }}" "$PROMPT_URL")

          # Store in env using heredoc to preserve multiline formatting
          {
            echo 'review_prompt<<EOF'
            echo "$PROMPT_CONTENT"
            echo 'EOF'
          } >> "$GITHUB_ENV"


      - name: AI PR REVIEW - ${{ matrix.stage.name }}
        id: run_stage
        uses: cockroachdb/claude-code-action@v1
        env:
          # Action requires these via env by name
          ANTHROPIC_VERTEX_PROJECT_ID: ${{ env.GCP_VERTEX_PROJECT_ID }}
          CLOUD_ML_REGION: ${{ env.CLOUD_ML_REGION }}
        with:
          github_token: ${{ secrets.token }}
          use_vertex: "true"
          claude_args: |
            --model ${{ inputs.model }}
            --allowedTools "${{ inputs.claude_allowed_tools }}"
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}

            ${{ env.review_prompt }}

            

      - name: Extract and Save ${{ matrix.stage.name }} Result
        id: stage_result
        if: steps.run_stage.conclusion == 'success'
        run: |
          mkdir -p review-results
          RESULT=$(jq -r '.[] | select(.type == "result") | .result' "${{ steps.run_stage.outputs.execution_file }}")
          echo "$RESULT" > review-results/${{ matrix.stage.name }}.txt
          echo "${{ matrix.stage.name }} result extracted (${#RESULT} characters)"

      - name: Upload ${{ matrix.stage.name }} Result
        if: steps.stage_result.conclusion == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: review-result-${{ matrix.stage.name }}
          path: review-results/${{ matrix.stage.name }}.txt
          retention-days: 1

  post-consolidated-review:
    runs-on: ubuntu-latest
    needs: claude-code-pr-review
    if: always()
    permissions:
      pull-requests: write

    steps:
      - name: Download All Review Results
        uses: actions/download-artifact@v4
        with:
          pattern: review-result-*
          path: all-results
          merge-multiple: true

      - name: Combine Results and Post Comment
        env:
          GH_TOKEN: ${{ secrets.token }}
        run: |
          # Start building the comment
          COMMENT_BODY="## ðŸ¤– AI PR Review Results"$'\n\n'

          # Check if we have any results
          if [ -d "all-results" ] && [ "$(ls -A all-results)" ]; then
            # Loop through all result files and combine them
            for result_file in all-results/*.txt; do
              if [ -f "$result_file" ]; then
                STAGE_NAME=$(basename "$result_file" .txt)
                COMMENT_BODY+="<details>"$'\n'
                COMMENT_BODY+="<summary>ðŸ“‹ <strong>${STAGE_NAME}</strong></summary>"$'\n\n'
                COMMENT_BODY+="$(cat "$result_file")"$'\n\n'
                COMMENT_BODY+="</details>"$'\n\n'
              fi
            done
            COMMENT_BODY+="---"$'\n\n'
            COMMENT_BODY+="*This review was generated automatically using AI analysis*"
          else
            COMMENT_BODY+="No review findings to report."$'\n\n'
            COMMENT_BODY+="---"$'\n\n'
            COMMENT_BODY+="*This review was generated automatically using AI analysis*"
          fi

          # Post the combined comment
          gh pr comment ${{ github.event.pull_request.number }} \
            --repo ${{ github.repository }} \
            --body "$COMMENT_BODY"
